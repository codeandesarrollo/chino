<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Terapia de Disparos ¬∑ Entrenamiento (Auto)</title>
<style>
  :root{
    --bg1:#0f172a; --bg2:#1e293b; --text:#e5e7eb; --muted:#94a3b8; --b:#1f2b46;
    --lane:#0c1528; --card:#0b1220cc; --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,Segoe UI,Roboto,Inter,sans-serif; color:var(--text);
    background:
      radial-gradient(900px 600px at 80% 90%, #0a182f 0, transparent 60%),
      radial-gradient(1200px 800px at 20% 10%, #0b1020 0, transparent 60%),
      linear-gradient(135deg,var(--bg1),var(--bg2));
    display:flex; align-items:center; justify-content:center; padding:16px;
  }
  .wrap{
    width:min(1000px,96vw); background:var(--card); border:1px solid var(--b); border-radius:18px;
    box-shadow:0 16px 40px rgba(0,0,0,.35); overflow:hidden; position:relative;
    -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
  }
  header{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:12px 14px; border-bottom:1px solid var(--b); background:#0b1428bf;
  }
  .title{display:flex; align-items:center; gap:10px}
  .logo{width:34px;height:34px;border-radius:12px;background:conic-gradient(from 0deg,#60a5fa,#22c55e,#60a5fa)}
  h1{margin:0;font-size:16px}
  .hud{display:flex; gap:8px; flex-wrap:wrap}
  .tag{border:1px solid #22345f; background:#0e1830; color:#cbd5e1; padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px}
  .main{display:grid; grid-template-columns:1fr 300px; gap:12px; padding:12px}
  @media (max-width:900px){ .main{grid-template-columns:1fr} .side{order:-1} }
  .stage{
    border:1px solid var(--b); border-radius:14px; background:var(--lane); position:relative; overflow:hidden;
    display:flex; align-items:center; justify-content:center; min-height:62vh;
  }
  canvas{ display:block; width:100%; height:100%; background:
    linear-gradient(0deg, #0b1426 0, #0c162a 100%);
    border-radius:14px;
  }
  .lanesOverlay{position:absolute; inset:0; pointer-events:none; display:grid; grid-template-columns:repeat(3,1fr); gap:0}
  .lanesOverlay i{border-left:1px dashed #22345f55; border-right:1px dashed #22345f55}
  .side{
    border:1px solid var(--b); border-radius:14px; background:#0c1528; padding:12px; display:flex; flex-direction:column; gap:10px
  }
  .controls{
    display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:4px;
  }
  .btn{
    padding:14px 16px; border-radius:14px; border:1px solid #1f2b46; background:#12203b; color:#e2e8f0;
    cursor:pointer; font-weight:900; font-size:18px; user-select:none; text-align:center;
    box-shadow:0 8px 22px rgba(0,0,0,.25); transition:transform .06s ease, box-shadow .2s ease;
  }
  .btn:active{ transform:scale(.98) }
  .btn.primary{ background:linear-gradient(180deg,#1e3a8a,#1d4ed8) }
  .btn.fire{ grid-column: span 2; font-size:22px; background:linear-gradient(180deg,#0f766e,#10b981) }
  .opt{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:14px}
  .bar{height:12px; border:1px solid #22345f; border-radius:999px; background:#0d172c; overflow:hidden}
  .bar i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#60a5fa)}
  .overlay{
    position:absolute; inset:0; display:none; align-items:center; justify-content:center; backdrop-filter: blur(6px);
    background:#071024d0; text-align:center; padding:20px; z-index:10;
  }
  .overlay.show{display:flex}
  .panel{background:#0c1528; border:1px solid #22345f; border-radius:16px; padding:22px; max-width:540px}
  .panel h2{margin:0 0 8px}
  .panel p{margin:6px 0; color:var(--muted)}
  .panic{
    position:absolute; bottom:12px; left:12px; right:12px; display:flex; gap:8px; z-index:6;
  }
  .panic .btn{flex:1}
</style>
</head>
<body>
<div class="wrap" role="application" aria-label="Terapia de disparos">
  <header>
    <div class="title"><div class="logo" aria-hidden="true"></div><h1>Disparos ¬∑ Entrenamiento (auto)</h1></div>
    <div class="hud">
      <span class="tag" id="tagScore">Puntos: 0</span>
      <span class="tag" id="tagHits">Derribos: 0 / 15</span>
      <span class="tag" id="tagLives">Vidas: 3</span>
    </div>
  </header>

  <div class="main">
    <section class="stage" id="stage">
      <canvas id="game" width="900" height="600" aria-label="Zona de juego"></canvas>
      <div class="lanesOverlay" aria-hidden="true"><i></i><i></i><i></i></div>

      <!-- Botones de emergencia grandes en m√≥vil -->
      <div class="panic">
        <button class="btn" id="btnLeft">‚Üê</button>
        <button class="btn fire" id="btnFire">DISPARAR</button>
        <button class="btn" id="btnRight">‚Üí</button>
      </div>
    </section>

    <aside class="side">
      <div>
        <h3 style="margin:0 0 6px">Objetivo</h3>
        <p style="margin:0; color:var(--muted)">Derriba <b>15 enemigos</b>. Mueve la mira y dispara. Tambi√©n puedes tocar al enemigo directamente.</p>
      </div>
      <div>
        <h3 style="margin:6px 0">Progreso</h3>
        <div class="bar"><i id="bar"></i></div>
      </div>
      <div>
        <h3 style="margin:6px 0">Opciones</h3>
        <label class="opt"><input type="checkbox" id="optAim" checked> Im√°n de mira (autoapunta a la calle con enemigo)</label>
        <label class="opt"><input type="checkbox" id="optSound" checked> Sonidos</label>
        <label class="opt"><input type="checkbox" id="optVibe" checked> Vibraci√≥n</label>
      </div>
      <div class="controls">
        <button class="btn" id="ctlLeft">‚Üê Izquierda</button>
        <button class="btn" id="ctlRight">Derecha ‚Üí</button>
        <button class="btn fire" id="ctlFire">DISPARAR</button>
      </div>
    </aside>
  </div>

  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-labelledby="ovTitle">
    <div class="panel">
      <h2 id="ovTitle">¬°Entrenamiento completado! üéØ</h2>
      <p id="ovText">Excelente trabajo. ¬øOtra ronda?</p>
      <div style="display:flex; gap:8px; justify-content:center; margin-top:10px">
        <button class="btn" id="btnAgain">Repetir</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  /* ============ Par√°metros del nivel ============ */
  const GOAL_KILLS = 15;
  const START_LIVES = 3;
  const LANES = 3;
  const ENEMY_SPAWN_MS = 900;     // cada cu√°nto aparece
  const ENEMY_SPEED = 90;         // px/s, baja velocidad para accesibilidad
  const BULLET_SPEED = 600;       // px/s
  const ENEMY_SIZE = 64;          // px (grande)
  const RETICLE_Y = 520;          // y de la mira
  const FIRE_COOLDOWN = 180;      // ms entre disparos
  const TAP_KILL_HITBOX = 42;     // radio t√°ctil grande

  /* ============ Estado ============ */
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  const stage = document.getElementById('stage');
  const dpr = Math.min(window.devicePixelRatio || 1, 2);
  let W = cvs.width, H = cvs.height;

  const ui = {
    tagScore: document.getElementById('tagScore'),
    tagHits:  document.getElementById('tagHits'),
    tagLives: document.getElementById('tagLives'),
    bar:      document.getElementById('bar'),
    overlay:  document.getElementById('overlay'),
    btnAgain: document.getElementById('btnAgain'),
    optAim:   document.getElementById('optAim'),
    optSound: document.getElementById('optSound'),
    optVibe:  document.getElementById('optVibe'),
    buttons: {
      left: document.getElementById('btnLeft'),
      right:document.getElementById('btnRight'),
      fire: document.getElementById('btnFire'),
      ctlLeft: document.getElementById('ctlLeft'),
      ctlRight:document.getElementById('ctlRight'),
      ctlFire: document.getElementById('ctlFire')
    }
  };

  const state = {
    running: false,
    lane: 1,               // 0..2
    lastFire: 0,
    score: 0,
    hits: 0,
    lives: START_LIVES,
    enemies: [],
    bullets: [],
    spawnTimer: 0,
    aimAssist: true,
    soundOn: true,
    vibeOn: true,
    lastT: 0,
    raf: null
  };

  /* ============ Utilidades ============ */
  function laneX(l){ return (W * (1/(LANES*2) + l/LANES)); }
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
  function vibe(ms=40){ if(state.vibeOn && 'vibrate' in navigator) navigator.vibrate(ms); }
  function beep(freq=520, dur=70, type='square'){
    if(!state.soundOn) return;
    const ctxA = beep.ctx || (beep.ctx = new (window.AudioContext||window.webkitAudioContext)());
    const o = ctxA.createOscillator(); const g = ctxA.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=0.04;
    o.connect(g); g.connect(ctxA.destination); o.start(); setTimeout(()=>o.stop(), dur);
  }
  function progressBar(){ ui.bar.style.width = Math.min(100, (state.hits/GOAL_KILLS)*100) + '%'; }
  function updateHUD(){
    ui.tagScore.textContent = 'Puntos: ' + state.score;
    ui.tagHits.textContent  = 'Derribos: ' + state.hits + ' / ' + GOAL_KILLS;
    ui.tagLives.textContent = 'Vidas: ' + state.lives;
    progressBar();
  }

  /* ============ Redimensionado ============ */
  function fit(){
    const rect = stage.getBoundingClientRect();
    const w = Math.max(600, rect.width - 2);
    const h = Math.max(380, rect.height - 2);
    cvs.style.width = w+'px'; cvs.style.height = h+'px';
    cvs.width = Math.round(w*dpr); cvs.height = Math.round(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    W = w; H = h;
  }
  window.addEventListener('resize', fit, {passive:true}); fit();

  /* ============ Entidades ============ */
  function spawnEnemy(){
    const lane = Math.floor(Math.random()*LANES);
    const x = laneX(lane);
    state.enemies.push({ lane, x, y: -ENEMY_SIZE, r: ENEMY_SIZE*0.5 });
  }

  function fire(){
    const now = performance.now();
    if(now - state.lastFire < FIRE_COOLDOWN) return;
    state.lastFire = now;
    // Asistencia: si hay enemigo en otra calle, mueve la mira a su calle
    if(state.aimAssist){
      const ahead = state.enemies.filter(e=>e.y<RETICLE_Y).sort((a,b)=>a.y-b.y)[0];
      if(ahead) state.lane = ahead.lane;
    }
    // Disparo recto en la calle actual
    const x = laneX(state.lane);
    state.bullets.push({ x, y: RETICLE_Y, r: 6 });
    beep(620,60,'square'); vibe(20);
  }

  /* ============ Colisiones ============ */
  function dist2(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy; }
  function hitEnemyAt(x,y, r=TAP_KILL_HITBOX){
    for(let i=0;i<state.enemies.length;i++){
      const e = state.enemies[i];
      if(dist2(x,y,e.x,e.y) <= (e.r+r)*(e.r+r)){
        // eliminar
        state.enemies.splice(i,1);
        onKill(e);
        return true;
      }
    }
    return false;
  }
  function onKill(e){
    state.score += 100;
    state.hits  += 1;
    beep(760,90,'triangle'); setTimeout(()=>beep(880,70,'triangle'),60); vibe(40);
    updateHUD();
    if(state.hits >= GOAL_KILLS){
      endGame(true);
    }
  }

  /* ============ Bucle ============ */
  function step(t){
    if(!state.running) return;
    const dt = (state.lastT? (t-state.lastT):16)/1000; state.lastT = t;

    // Spawns
    state.spawnTimer += dt*1000;
    if(state.spawnTimer >= ENEMY_SPAWN_MS){
      state.spawnTimer = 0; spawnEnemy();
    }

    // Mover enemigos
    for(const e of state.enemies){ e.y += ENEMY_SPEED*dt; }

    // Mover balas
    for(const b of state.bullets){ b.y -= BULLET_SPEED*dt; }

    // Colisi√≥n bala-enemigo
    outer: for(let i=state.bullets.length-1;i>=0;i--){
      const b = state.bullets[i];
      for(let j=state.enemies.length-1;j>=0;j--){
        const e = state.enemies[j];
        if(dist2(b.x,b.y, e.x,e.y) <= (e.r+b.r)*(e.r+b.r)){
          state.bullets.splice(i,1);
          state.enemies.splice(j,1);
          onKill(e);
          continue outer;
        }
      }
    }

    // Enemigos que llegan abajo
    for(let i=state.enemies.length-1;i>=0;i--){
      const e = state.enemies[i];
      if(e.y - e.r > H){
        state.enemies.splice(i,1);
        state.lives -= 1;
        beep(200,120,'sawtooth'); vibe(80);
        updateHUD();
        if(state.lives <= 0){ endGame(false); }
      }
    }

    // Limpiar balas fuera
    state.bullets = state.bullets.filter(b=> b.y + b.r > 0);

    // Dibujo
    draw();

    // Siguiente frame
    state.raf = requestAnimationFrame(step);
  }

  /* ============ Dibujo ============ */
  function draw(){
    ctx.clearRect(0,0,W,H);

    // Fondo suave
    const grd = ctx.createLinearGradient(0,0,0,H);
    grd.addColorStop(0,'#0b1426'); grd.addColorStop(1,'#0c162a');
    ctx.fillStyle = grd; ctx.fillRect(0,0,W,H);

    // Calles
    for(let l=1;l<LANES;l++){
      const x = l*W/LANES;
      ctx.strokeStyle = '#22345f55'; ctx.setLineDash([8,6]);
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); ctx.setLineDash([]);
    }

    // Enemigos (discos grandes brillantes)
    for(const e of state.enemies){
      ctx.save();
      const glow = ctx.createRadialGradient(e.x, e.y, e.r*0.2, e.x, e.y, e.r);
      glow.addColorStop(0,'#60a5fa'); glow.addColorStop(1,'#1b3b77');
      ctx.fillStyle = glow;
      ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle = '#8ec5ff'; ctx.lineWidth = 2; ctx.stroke();
      ctx.restore();
    }

    // Balas
    ctx.fillStyle = '#a7f3d0';
    for(const b of state.bullets){
      ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
      ctx.fillRect(b.x-2, b.y, 4, 12);
    }

    // Mira
    const rx = laneX(state.lane), ry = RETICLE_Y;
    ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(rx,ry,20,0,Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(rx-26,ry); ctx.lineTo(rx+26,ry);
    ctx.moveTo(rx,ry-26); ctx.lineTo(rx,ry+26); ctx.stroke();
  }

  /* ============ Control ============ */
  function moveLeft(){ state.lane = clamp(state.lane-1, 0, LANES-1); vibe(15); }
  function moveRight(){ state.lane = clamp(state.lane+1, 0, LANES-1); vibe(15); }

  // Controles t√°ctiles / botones grandes
  ui.buttons.left.addEventListener('click', moveLeft);
  ui.buttons.right.addEventListener('click', moveRight);
  ui.buttons.fire.addEventListener('click', fire);

  ui.buttons.ctlLeft.addEventListener('click', moveLeft);
  ui.buttons.ctlRight.addEventListener('click', moveRight);
  ui.buttons.ctlFire.addEventListener('click', fire);

  // Teclado
  window.addEventListener('keydown', (e)=>{
    if(e.code==='ArrowLeft' || e.code==='KeyA'){ e.preventDefault(); moveLeft(); }
    if(e.code==='ArrowRight'|| e.code==='KeyD'){ e.preventDefault(); moveRight(); }
    if(e.code==='Space' || e.code==='Enter'){ e.preventDefault(); fire(); }
  });

  // Tocar directamente un enemigo para derribarlo
  cvs.addEventListener('click', (e)=>{
    const rect = cvs.getBoundingClientRect();
    const x = (e.clientX - rect.left), y = (e.clientY - rect.top);
    if(hitEnemyAt(x, y)){ /* ya suma dentro de onKill */ }
  });

  // Opciones
  ui.optAim.addEventListener('change', ()=> state.aimAssist = ui.optAim.checked);
  ui.optSound.addEventListener('change', ()=> state.soundOn = ui.optSound.checked);
  ui.optVibe.addEventListener('change', ()=> state.vibeOn  = ui.optVibe.checked);

  // Repetir
  ui.btnAgain.addEventListener('click', ()=> start());

  /* ============ Inicio / Fin ============ */
  function start(){
    // Reset
    cancelAnimationFrame(state.raf||0);
    state.running = true;
    state.lane = 1;
    state.lastFire = 0;
    state.score = 0; state.hits = 0; state.lives = START_LIVES;
    state.enemies.length = 0; state.bullets.length = 0;
    state.spawnTimer = 400; // que aparezca pronto
    state.lastT = 0;
    ui.overlay.classList.remove('show');
    updateHUD();
    step(performance.now());
  }

  function endGame(win){
    state.running = false;
    cancelAnimationFrame(state.raf||0);
    const ovText = document.getElementById('ovText');
    const title  = document.getElementById('ovTitle');
    if(win){
      title.textContent = '¬°Entrenamiento completado! üéØ';
      ovText.textContent = `Puntos: ${state.score} ¬∑ Derribos: ${state.hits}/${GOAL_KILLS}`;
      beep(800,120,'triangle'); setTimeout(()=>beep(920,100,'triangle'),100);
    }else{
      title.textContent = 'Se acabaron las vidas üòµ';
      ovText.textContent = `Puntos: ${state.score} ¬∑ Derribos: ${state.hits}/${GOAL_KILLS}. ¬°Int√©ntalo de nuevo!`;
      beep(200,220,'sawtooth');
    }
    ui.overlay.classList.add('show');
  }

  // Auto-inicio
  window.addEventListener('load', ()=> setTimeout(start, 300));
})();
</script>
</body>
</html>
